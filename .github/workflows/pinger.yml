name: Pinger

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:         # allow manual runs

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping backend to prevent sleep
        env:
          URL: https://cognify-backend-dymx.onrender.com/
        run: |
          echo "=================================================="
          echo "üîî PING ATTEMPT STARTED"
          echo "üìÖ Current time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "üåê Target URL: $URL"
          echo "=================================================="
          echo ""
          
          # Record start time
          START_TIME=$(date +%s)
          
          # Ping the server
          echo "‚è≥ Sending request..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}|%{time_total}" "$URL" --max-time 30)
          
          # Parse response
          STATUS=$(echo $RESPONSE | cut -d'|' -f1)
          TIME_TAKEN=$(echo $RESPONSE | cut -d'|' -f2)
          
          echo ""
          echo "=================================================="
          echo "üì° RESPONSE RECEIVED"
          echo "Status Code: $STATUS"
          echo "Response Time: ${TIME_TAKEN}s"
          echo "üìÖ Completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "=================================================="
          echo ""
          
          # Check if server is alive
          if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 404 ] || [ "$STATUS" -eq 307 ]; then
            echo "‚úÖ SUCCESS: Server is AWAKE and responding!"
            echo "   This ping will keep the server alive for ~15 minutes"
            echo "   Next ping scheduled in 12 minutes"
            echo ""
            echo "‚è±Ô∏è  TIMING INFO:"
            echo "   - Current interval: 12 minutes"
            echo "   - Server stays alive: ~15 minutes after last request"
            echo "   - Safety buffer: 3 minutes"
            exit 0
          elif [ "$STATUS" -eq 000 ] || [ -z "$STATUS" ]; then
            echo "‚ùå FAILURE: Server is NOT responding (timeout or connection failed)"
            echo "   This might mean:"
            echo "   - Server is sleeping/cold start needed"
            echo "   - Server is down"
            echo "   - Network issue"
            echo ""
            echo "‚ö†Ô∏è  ACTION REQUIRED:"
            echo "   If this happens frequently, reduce the interval to 10 minutes"
            echo "   Edit cron: '*/10 * * * *' in the workflow file"
            exit 1
          else
            echo "‚ö†Ô∏è  WARNING: Unexpected status code $STATUS"
            echo "   Server responded but with unexpected code"
            echo "   This still counts as server being awake!"
            exit 0
          fi