name: Pinger

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  ping:
    runs-on: ubuntu-latest
    
    permissions:
      actions: write
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Ping backend with retry
        env:
          URL: https://cognify-backend-dymx.onrender.com/
          MAX_RETRIES: 5
          RETRY_DELAY: 30
        run: |
          echo "=================================================="
          echo "🔔 PING CYCLE STARTED"
          echo "📅 Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "🌐 Target: $URL"
          echo "=================================================="
          echo ""
          
          ATTEMPT=1
          SUCCESS=false
          
          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "🎯 ATTEMPT #$ATTEMPT of $MAX_RETRIES"
            echo "📅 $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            echo "⏳ Sending request..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}|%{time_total}" "$URL" --max-time 30 2>&1)
            CURL_EXIT_CODE=$?
            
            STATUS=$(echo $RESPONSE | cut -d'|' -f1)
            TIME_TAKEN=$(echo $RESPONSE | cut -d'|' -f2)
            
            echo ""
            echo "📊 RESPONSE:"
            echo "   Status: $STATUS"
            echo "   Time: ${TIME_TAKEN}s"
            echo "   Exit Code: $CURL_EXIT_CODE"
            echo ""
            
            if [ "$CURL_EXIT_CODE" -eq 0 ] && { [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 404 ] || [ "$STATUS" -eq 307 ]; }; then
              echo "✅ SUCCESS: Server is AWAKE!"
              echo ""
              echo "📈 STATS:"
              echo "   Attempts: $ATTEMPT"
              echo "   Status: HEALTHY"
              echo "   Next ping: 10 minutes"
              SUCCESS=true
              break
              
            elif [ "$STATUS" -eq 000 ] || [ -z "$STATUS" ] || [ "$CURL_EXIT_CODE" -ne 0 ]; then
              echo "❌ FAILURE: Not responding"
              
              if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                echo "🔄 Retrying in ${RETRY_DELAY}s..."
                echo ""
                sleep $RETRY_DELAY
                ATTEMPT=$((ATTEMPT + 1))
              else
                echo "⛔ MAX RETRIES REACHED"
                break
              fi
            else
              echo "⚠️  Status $STATUS - Server awake"
              SUCCESS=true
              break
            fi
          done
          
          echo ""
          echo "=================================================="
          echo "📋 SUMMARY"
          echo "Status: $([ "$SUCCESS" = true ] && echo "✅ SUCCESS" || echo "❌ FAILED")"
          echo "Attempts: $ATTEMPT"
          echo "Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "=================================================="
          
          # Always exit 0 to prevent workflow from being disabled
          if [ "$SUCCESS" = true ]; then
            echo "🎉 Server alive - exiting with success"
            exit 0
          else
            echo "⚠️  Ping failed but continuing workflow to prevent disable"
            exit 0
          fi
      
      - name: Keep workflow alive
        if: always()
        run: |
          echo "Last ping: $(date -u)" > .github/workflows/.keepalive